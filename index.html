<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D World</title>

<style>
body { margin:0; overflow:hidden; background:black; }

/* „ÇØ„É≠„Çπ„Éò„Ç¢ */
#crosshair{
  position:fixed;
  top:50%; left:50%;
  width:20px; height:20px;
  margin:-10px 0 0 -10px;
  pointer-events:none;
  z-index:1000;
}
#crosshair::before,#crosshair::after{
  content:""; position:absolute; background:white;
}
#crosshair::before{ left:9px; top:0; width:2px; height:20px; }
#crosshair::after{ top:9px; left:0; width:20px; height:2px; }

/* „Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ */
#joyZone{
  position:fixed;
  bottom:40px; left:40px;
  width:150px; height:150px;
  z-index:2000;
}
</style>

<!-- üî• „Åì„Åì„ÅåÈáçË¶ÅÔºöimport map -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
  }
}
</script>

</head>
<body>

<div id="crosshair"></div>
<div id="joyZone"></div>

<script type="module">

import * as THREE from "three";
import { PointerLockControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/PointerLockControls.js";

const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// ===== „Ç∑„Éº„É≥ =====
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(5,1.6,5);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// ===== ÂÖâ =====
scene.add(new THREE.AmbientLight(0xffffff,0.4));
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,20,10);
scene.add(light);

// ===== Âú∞Èù¢ =====
for(let x=0;x<50;x++){
  for(let z=0;z<50;z++){
    const tile=new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshLambertMaterial({color:0x228B22})
    );
    tile.position.set(x,-0.5,z);
    scene.add(tile);
  }
}

// ===== „Ç≥„É≥„Éà„É≠„Éº„É´ =====
let controls;
let moveF=0, moveR=0;

if(!isMobile){
  controls=new PointerLockControls(camera,document.body);
  scene.add(controls.getObject());
  document.addEventListener("click",()=>controls.lock());
  document.getElementById("joyZone").style.display="none";
}else{
  controls={getObject:()=>camera};
  document.getElementById("crosshair").style.display="none";

  const script=document.createElement("script");
  script.src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js";
  document.body.appendChild(script);

  script.onload=()=>{
    const joystick=nipplejs.create({
      zone:document.getElementById("joyZone"),
      mode:"static",
      position:{left:"75px",top:"75px"},
      color:"white"
    });

    joystick.on("move",(evt,data)=>{
      moveF=-data.vector.y;
      moveR=data.vector.x;
    });

    joystick.on("end",()=>{
      moveF=0; moveR=0;
    });
  };
}

// ===== Áâ©ÁêÜ =====
let vY=0;
const gravity=-0.02;
const jumpPower=0.5;
let onGround=true;

const keys={};

document.addEventListener("keydown",e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.code==="Space"&&onGround){
    vY=jumpPower;
    onGround=false;
  }
});
document.addEventListener("keyup",e=>{
  keys[e.key.toLowerCase()]=false;
});

// ===== Êõ¥Êñ∞ =====
function update(){

  const speed=keys["shift"]?0.3:0.15;

  if(!isMobile){
    if(keys["w"]) controls.moveForward(speed);
    if(keys["s"]) controls.moveForward(-speed);
    if(keys["a"]) controls.moveRight(-speed);
    if(keys["d"]) controls.moveRight(speed);
  }else{
    camera.translateZ(moveF*0.15);
    camera.translateX(moveR*0.15);
  }

  vY+=gravity;
  camera.position.y+=vY;

  if(camera.position.y<=1.6){
    vY=0;
    camera.position.y=1.6;
    onGround=true;
  }
}

function animate(){
  requestAnimationFrame(animate);
  update();
  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

</script>
</body>
</html>
